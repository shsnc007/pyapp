# -*- coding: utf-8 -*-
"""
Tencent is pleased to support the open source community by making è“é²¸æ™ºäº‘(BlueKing) available.
Copyright (C) 2017 THL A29 Limited, a Tencent company. All rights reserved.
Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://opensource.org/licenses/MIT
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.

Django settings for app-framework project.

Generated by 'django-admin startproject' using Django 1.8.3.

For more information on this file, see
https://docs.djangoproject.com/en/1.8/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/1.8/ref/settings/

"""

import os
import sys
# Import global settings to make it easier to extend settings.
from django.conf.global_settings import *  # noqa


# ==============================================================================
# åº”ç”¨åŸºæœ¬ä¿¡æ¯é…ç½® (è¯·æŒ‰ç…§è?´æ˜ä¿?æ”?)
# ==============================================================================
# åœ¨è“é²¸æ™ºäº‘å¼€å‘è€…ä¸­å¿? -> ç‚¹å‡»åº”ç”¨ID -> åŸºæœ¬ä¿¡æ¯ ä¸?è·å– APP_ID å’? APP_TOKEN çš„å€?
APP_ID = 'pyapp'
APP_TOKEN = 'c5574249-298c-4f3e-b760-bec4df8fc217'
# è“é²¸æ™ºäº‘å¼€å‘è€…ä¸­å¿ƒçš„åŸŸåï¼Œå½¢å¦‚ï¼šhttp://paas.bking.com
BK_PAAS_HOST = 'http://paas.bk.com'

# è¯·æ±‚å®˜æ–¹ API é»˜è?¤ç‰ˆæœ?å·ï¼Œå?é€‰å€¼ä¸ºï¼?"v2" æˆ? ""ï¼›å…¶ä¸?ï¼?"v2"è¡¨ç¤ºè§„èŒƒåŒ–APIï¼?""è¡¨ç¤ºæœ?è§„èŒƒåŒ–API
DEFAULT_BK_API_VER = 'v2'

# æ˜?å¦å¯ç”¨celeryä»»åŠ¡
IS_USE_CELERY = False
# æœ?åœ°å¼€å‘çš„ celery çš„æ¶ˆæ?é˜Ÿåˆ—ï¼ˆRabbitMQï¼‰ä¿¡æ?
BROKER_URL_DEV = 'amqp://guest:guest@127.0.0.1:5672/'
# TOCHANGE è°ƒç”¨celeryä»»åŠ¡çš„æ–‡ä»¶è·¯å¾?, List of modules to import when celery starts.
CELERY_IMPORTS = (
    'home_application.celery_tasks',
)

# ==============================================================================
# åº”ç”¨è¿è?Œç¯å¢ƒé…ç½?ä¿¡æ¯
# ==============================================================================
ENVIRONMENT = os.environ.get('BK_ENV', 'development')

# åº”ç”¨åŸºæœ¬ä¿¡æ¯ä»ç¯å¢ƒå˜é‡ä¸­è·å–ï¼Œæœªè®¾ç½®ç?å¢ƒå˜é‡?(å¦‚ï¼šæœ?åœ°å¼€å?)æ—¶ï¼Œåˆ™ç”¨ç”¨æˆ·åœ¨æ–‡ä»¶å¼€å¤´çš„å¡?å†™çš„å€?
APP_ID = os.environ.get('APP_ID', APP_ID)
APP_TOKEN = os.environ.get('APP_TOKEN', APP_TOKEN)
BK_PAAS_HOST = os.environ.get('BK_PAAS_HOST', BK_PAAS_HOST)

# åº”ç”¨è®¿é—®è·?å¾?
SITE_URL = '/'
# è¿è?Œæ¨¡å¼ï¼Œ DEVELOP(å¼€å‘æ¨¡å¼?)ï¼? TEST(æµ‹è¯•æ¨¡å¼)ï¼? PRODUCT(æ­£å¼æ¨¡å¼)
RUN_MODE = 'DEVELOP'
if ENVIRONMENT.endswith('production'):
    RUN_MODE = 'PRODUCT'
    DEBUG = False
    SITE_URL = '/o/%s/' % APP_ID
elif ENVIRONMENT.endswith('testing'):
    RUN_MODE = 'TEST'
    DEBUG = False
    SITE_URL = '/t/%s/' % APP_ID
else:
    RUN_MODE = 'DEVELOP'
    DEBUG = True


try:
    import pymysql
    pymysql.install_as_MySQLdb()
except:
    pass

# ===============================================================================
# åº”ç”¨åŸºæœ¬ä¿¡æ¯
# ===============================================================================
# åº”ç”¨å¯†é’¥
SECRET_KEY = 'MQtd_0cw&AiY5jT&&#w7%9sCK=HW$O_e%ch4xDd*AaP(xU0s3X'
# CSRFçš„COOKIEåŸŸï¼Œé»˜è?¤ä½¿ç”¨å½“å‰åŸŸ
# CSRF_COOKIE_DOMAIN =''
CSRF_COOKIE_PATH = SITE_URL

ALLOWED_HOSTS = ['*']
# ==============================================================================
# Middleware and apps
# ==============================================================================
MIDDLEWARE_CLASSES = (
    'django.middleware.common.CommonMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.auth.middleware.SessionAuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'account.middlewares.LoginMiddleware',   # ç™»å½•é‰´æƒä¸?é—´ä»¶
    'common.middlewares.CheckXssMiddleware',  # Xssæ”»å‡»å¤„ç†ä¸?é—´ä»¶
)

INSTALLED_APPS = (
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.sites',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.admin',
    # OTHER 3rd Party App
    'app_control',
    'account',
    'home_application',
)

# ==============================================================================
# Django é¡¹ç›®é…ç½®
# ==============================================================================
TIME_ZONE = 'Asia/Shanghai'
LANGUAGE_CODE = 'zh-CN'
SITE_ID = 1
USE_I18N = True
USE_L10N = True

# é¡¹ç›®è·?å¾?
PROJECT_PATH = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT, PROJECT_MODULE_NAME = os.path.split(PROJECT_PATH)
BASE_DIR = os.path.dirname(os.path.dirname(PROJECT_PATH))
PYTHON_BIN = os.path.dirname(sys.executable)

# ===============================================================================
# é™æ€èµ„æºè?¾ç½®
# ===============================================================================
# é™æ€èµ„æºæ–‡ä»?(js,cssç­‰ï¼‰åœ¨åº”ç”¨ä¸Šçº¿æ›´æ–°å, ç”±äºæµè?ˆå™¨æœ‰ç¼“å­?, å?èƒ½ä¼šé€ æˆæ²¡æ›´æ–°çš„æƒ…å†µ.
# æ‰€ä»¥åœ¨å¼•ç”¨é™æ€èµ„æºçš„åœ°æ–¹ï¼Œéƒ½éœ€è¦åŠ ä¸Šè¿™ä¸?ç‰ˆæœ¬å·ï¼Œå¦‚ï¼š<script src="/a.js?v=${STATIC_VERSION}"></script>ï¼?
# å¦‚æœé™æ€èµ„æºä¿®æ”¹äº†ä»¥åï¼Œä¸Šçº¿å‰ä¿?æ”¹è¿™ä¸?ç‰ˆæœ¬å·å³å?
STATICFILES_DIRS = (
    os.path.join(PROJECT_ROOT, 'static'),
)
STATIC_VERSION = 0.1
# åº”ç”¨æœ?åœ°é™æ€èµ„æºç›®å½?
STATIC_URL = '%sstatic/' % SITE_URL

ROOT_URLCONF = 'urls'
# ==============================================================================
# Templates
# ==============================================================================
# mako template dir
MAKO_TEMPLATE_DIR = os.path.join(PROJECT_ROOT, 'templates')
MAKO_TEMPLATE_MODULE_DIR = os.path.join(BASE_DIR, 'templates_module', APP_ID)
if RUN_MODE not in ['DEVELOP']:
    MAKO_TEMPLATE_MODULE_DIR = os.path.join(PROJECT_ROOT, 'templates_module', APP_ID)
# Django TEMPLATESé…ç½®
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(PROJECT_ROOT, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                # the context to the templates
                'django.contrib.auth.context_processors.auth',
                'django.template.context_processors.request',
                'django.template.context_processors.csrf',
                'common.context_processors.mysetting',   # è‡?å®šä¹‰æ¨¡ç‰ˆcontextï¼Œå¯åœ¨é¡µé?ä¸?ä½¿ç”¨STATIC_URLç­‰å˜é‡?
                'django.template.context_processors.i18n',
            ],
            'debug': DEBUG
        },
    },
]
# ==============================================================================
# session and cache
# ==============================================================================
SESSION_EXPIRE_AT_BROWSER_CLOSE = True       # é»˜è?¤ä¸ºfalse,ä¸ºtrueæ—¶SESSION_COOKIE_AGEæ— æ•ˆ
SESSION_COOKIE_PATH = SITE_URL               # NOTE ä¸è?æ”¹åŠ?ï¼Œå¦åˆ™ï¼Œå?èƒ½ä¼šæ”¹æˆå’Œå…¶ä»–appçš„ä¸€æ ·ï¼Œè¿™æ ·ä¼šå½±å“ç™»å½?

# ===============================================================================
# Authentication
# ===============================================================================
AUTH_USER_MODEL = 'account.BkUser'
AUTHENTICATION_BACKENDS = ('account.backends.BkBackend', 'django.contrib.auth.backends.ModelBackend')
LOGIN_URL = "%s/login/?app_id=%s" % (BK_PAAS_HOST, APP_ID)
LOGOUT_URL = '%saccount/logout/' % SITE_URL
LOGIN_REDIRECT_URL = SITE_URL
REDIRECT_FIELD_NAME = "c_url"
# éªŒè¯ç™»å½•çš„cookieå?
BK_COOKIE_NAME = 'bk_token'
# æ•°æ®åº“åˆå§‹åŒ– ç®¡ç†å‘˜åˆ—è¡?
ADMIN_USERNAME_LIST = ['admin']

# ===============================================================================
# CELERY é…ç½®
# ===============================================================================
if IS_USE_CELERY:
    try:
        import djcelery
        INSTALLED_APPS += (
            'djcelery',            # djcelery
        )
        djcelery.setup_loader()
        CELERY_ENABLE_UTC = False
        CELERYBEAT_SCHEDULER = "djcelery.schedulers.DatabaseScheduler"
        if "celery" in sys.argv:
            DEBUG = False
        # celery çš„æ¶ˆæ?é˜Ÿåˆ—ï¼ˆRabbitMQï¼‰ä¿¡æ?
        BROKER_URL = os.environ.get('BK_BROKER_URL', BROKER_URL_DEV)
        if RUN_MODE == 'DEVELOP':
            from celery.signals import worker_process_init

            @worker_process_init.connect
            def configure_workers(*args, **kwargs):
                import django
                django.setup()
    except:
        pass

# ==============================================================================
# logging
# ==============================================================================
# åº”ç”¨æ—¥å¿—é…ç½®
BK_LOG_DIR = os.environ.get('BK_LOG_DIR', '/data/paas/apps/logs/')
LOGGING_DIR = os.path.join(BASE_DIR, 'logs', APP_ID)
LOG_CLASS = 'logging.handlers.RotatingFileHandler'
if RUN_MODE == 'DEVELOP':
    LOG_LEVEL = 'DEBUG'
elif RUN_MODE == 'TEST':
    LOGGING_DIR = os.path.join(BK_LOG_DIR, APP_ID)
    LOG_LEVEL = 'INFO'
elif RUN_MODE == 'PRODUCT':
    LOGGING_DIR = os.path.join(BK_LOG_DIR, APP_ID)
    LOG_LEVEL = 'ERROR'

# è‡?åŠ¨å»ºç«‹æ—¥å¿—ç›®å½?
if not os.path.exists(LOGGING_DIR):
    try:
        os.makedirs(LOGGING_DIR)
    except:
        pass

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '%(levelname)s [%(asctime)s] %(pathname)s %(lineno)d %(funcName)s %(process)d %(thread)d \n \t %(message)s \n',  # noqa
            'datefmt': '%Y-%m-%d %H:%M:%S'
        },
        'simple': {
            'format': '%(levelname)s %(message)s \n'
        },
    },
    'handlers': {
        'null': {
            'level': 'DEBUG',
            'class': 'django.utils.log.NullHandler',
        },
        'mail_admins': {
            'level': 'ERROR',
            'class': 'django.utils.log.AdminEmailHandler'
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'simple'
        },
        'root': {
            'class': LOG_CLASS,
            'formatter': 'verbose',
            'filename': os.path.join(LOGGING_DIR, '%s.log' % APP_ID),
            'maxBytes': 1024 * 1024 * 10,
            'backupCount': 5
        },
        'component': {
            'class': LOG_CLASS,
            'formatter': 'verbose',
            'filename': os.path.join(LOGGING_DIR, 'component.log'),
            'maxBytes': 1024 * 1024 * 10,
            'backupCount': 5
        },
        'wb_mysql': {
            'class': LOG_CLASS,
            'formatter': 'verbose',
            'filename': os.path.join(LOGGING_DIR, 'wb_mysql.log'),
            'maxBytes': 1024 * 1024 * 4,
            'backupCount': 5
        },
    },
    'loggers': {
        'django': {
            'handlers': ['null'],
            'level': 'INFO',
            'propagate': True,
        },
        'django.request': {
            'handlers': ['console'],
            'level': 'ERROR',
            'propagate': True,
        },
        # the root logger ,ç”¨äºæ•´ä¸ªprojectçš„logger
        'root': {
            'handlers': ['root'],
            'level': LOG_LEVEL,
            'propagate': True,
        },
        # ç»„ä»¶è°ƒç”¨æ—¥å¿—
        'component': {
            'handlers': ['component'],
            'level': 'WARN',
            'propagate': True,
        },
        # other loggers...
        'django.db.backends': {
            'handlers': ['wb_mysql'],
            'level': 'DEBUG',
            'propagate': True,
        },
    }
}
